/*
* jQuery throttle / debounce - v1.1 - 3/7/2010
* http://benalman.com/projects/jquery-throttle-debounce-plugin/
*
* Copyright (c) 2010 "Cowboy" Ben Alman
* Dual licensed under the MIT and GPL licenses.
* http://benalman.com/about/license/
*/
(function(b,c){var $=b.jQuery||b.Cowboy||(b.Cowboy={}),a;$.throttle=a=function(e,f,j,i){var h,d=0;if(typeof f!=="boolean"){i=j;j=f;f=c}function g(){var o=this,m=+new Date()-d,n=arguments;function l(){d=+new Date();j.apply(o,n)}function k(){h=c}if(i&&!h){l()}h&&clearTimeout(h);if(i===c&&m>e){l()}else{if(f!==true){h=setTimeout(i?k:l,i===c?e-m:e)}}}if($.guid){g.guid=j.guid=j.guid||$.guid++}return g};$.debounce=function(d,e,f){return f===c?a(d,e,false):a(d,f,e!==false)}})(this);

/* main.js */

var global_hooks = {
	win: $(window),
	doc: $(document),
	body: $('body'),
	mobile: (/Mobile|iP(hone|od|ad)|Android|BlackBerry|IEMobile|Kindle|NetFront|Silk-Accelerated|(hpw|web)OS|Fennec|Minimo|Opera M(obi|ini)|Blazer|Dolfin|Dolphin|Skyfire|Zune/i).test(navigator.userAgent.toLowerCase()) && 'ontouchstart' in document.documentElement
}

/* clickfix */

function clickfix(target, pane) {
	var cfix_target = target;
	var cfix_pane = pane;
	var cfix_last = pane.find('a').last();
	var cfix_open = false;
	cfix_target.on('click.clickfix', function(e) {
		e.preventDefault();
		if (cfix_open === false) {
			cfix_open = true;
			cfix_target.addClass('show');
			cfix_pane.addClass('show');
		}
		else {
			cfix_open = false;
			cfix_target.removeClass('show');
			cfix_pane.removeClass('show');
		}
	});
	cfix_last.on('blur.clickfix', function() {
		cfix_open = false;
		cfix_target.removeClass('show');
		cfix_pane.removeClass('show');
	});
}
clickfix($('#m-nav-main'), $('#header-nav-pane'));
clickfix($('#m-nav-legal'), $('#m-nav-legal + ul'));

/* hoverfix */

function hoverfix(target, parent, pane) {
	var hfix_target = target;
	var hfix_parent = parent;
	var hfix_pane = pane;
	var hfix_last = pane.find('a').last();
	hfix_target.on('mouseover.hoverfix focus.hoverfix', function() {
		hfix_parent.addClass('show');
	});
	hfix_parent.on('mouseleave.hoverfix', function() {
		hfix_parent.removeClass('show');
	});
	hfix_last.on('blur.hoverfix', function() {
		hfix_parent.removeClass('show');
	});
}
var nav_main_hover = $('#header-nav-pane > nav > ul > li').children('a:not("#contact-link")');
$.each(nav_main_hover, function(index) {
	hoverfix(nav_main_hover.eq(index), nav_main_hover.eq(index).parent('li'), nav_main_hover.eq(index).next('ul'));
});

/* telfix */

if (!global_hooks.mobile) {
	$('a.tel').attr('href', '/contact');
}

/* form verify */

function formverify(target) {
	var vform_target = target;
	for (var i = 0; i < vform_target.length; i++) {
		(function(vform_target_current) {
			vform_target_current.on('submit.formverify', function(e) {
				if (!vform_check(vform_target_current)) {
					e.preventDefault();
					e.stopPropagation();
				}
			});
		})(vform_target.eq(i));
	}
	function vform_check(vform_current) {
		var vform_state = true;
		var vform_required = vform_current.find('input[required]');
		for (var j = 0; j < vform_required.length; j++) {
			(function(vform_req_input) {
				var vform_req_label = vform_target.find('label[for="' + vform_req_input.attr('id') + '"]');
				if (vform_req_input.val() === null || vform_req_input.val() === '') {
					vform_state = false;
					vform_req_input.addClass('invalid');
					vform_req_label.addClass('invalid');
				}
				else {
					vform_req_input.removeClass('invalid');
					vform_req_label.removeClass('invalid');
				}
			})(vform_required.eq(j));
		}
		return vform_state;
	}
}
formverify($('form.form-verify'));

/* contact form handler */

var contactform_handler = {
	bound: false,
	valid: false,
	fn_init: function() {
		this.form = $('#contact-form-short');
		this.valid = this.form.length;
		if (this.valid === 1) {
			this.link = $('#contact-link');
			this.overlay = $('#contact-overlay');
			this.close = this.form.find('#contact-close');
			this.first = this.form.find('input:not([type=hidden])').first();
			this.close.on('click.formclose', function(e) {
				e.preventDefault();
				contactform_handler.fn_hide();
			});
			this.overlay.on('click.formclose', function(e) {
				e.preventDefault();
				contactform_handler.fn_hide();
			});
		}
	},
	fn_show: function() {
		this.link.addClass('show');
		this.form.addClass('show');
		this.overlay.addClass('show');
		this.first.focus();
	},
	fn_hide: function() {
		this.link.removeClass('show');
		this.form.removeClass('show');
		this.overlay.removeClass('show');
	},
	fn_toggle: function() {
		if (this.form.is(':hidden')) {
			this.fn_show();
		}
		else {
			this.fn_hide();
		}
	},
	fn_bind: function() {
		if (!this.bound) {
			this.link.on('click.formopen', function(e) {
				e.preventDefault();
				contactform_handler.fn_toggle();
			});
			this.bound = true;
		}
	},
	fn_unbind: function() {
		if (this.bound) {
			this.link.off('click.formopen');
			this.bound = false;
		}
		this.fn_hide();
	}
}

/* stickynav */

var stickynav_handler = {
	headerbar: $('#header-bar'),
	position: 0,
	active: false,
	state: -1,
	fn_calc: function(snav_pos, snav_height) {
		this.offset = this.headerbar.outerHeight();
		this.height = snav_height;
		this.fn_move(snav_pos);
	},
	fn_move: function(snav_pos) {
		this.position = snav_pos;
		if (this.position === 0) {
			if (this.state !== 1) {
				this.state = 1;
				this.headerbar.css({
					position: 'absolute',
					top: (this.height - this.offset) + 'px'
				}).addClass('hb-stickynav-start').removeClass('hb-stickynav-scroll hb-stickynav-stop');
			}
		}
		else if (this.position > 0 && this.position < (this.height - this.offset)) {
			this.headerbar.css({
				position: 'absolute',
				top: (this.height - this.offset) + 'px'
			});
			if (this.state !== 2) {
				this.state = 2;
				this.headerbar.addClass('hb-stickynav-scroll').removeClass('hb-stickynav-start hb-stickynav-stop');
			}
		}
		else if (this.position >= (this.height - this.offset)) {
			if (this.state !== 3) {
				this.state = 3;
				this.headerbar.css({
					position:'fixed',
					top: 0
				}).addClass('hb-stickynav-stop').removeClass('hb-stickynav-start hb-stickynav-scroll');
			}
		}
	}
}

contactform_handler.fn_init();
var site_fullscreen = global_hooks.body.hasClass('fullscreen');

// initialize
var site_width = global_hooks.win.width();
var site_height = global_hooks.win.height();
// greater than desktop size
if (site_width >= 780) {
	if (site_fullscreen) {
		stickynav_handler.active = true;
		stickynav_handler.fn_calc(global_hooks.win.scrollTop(), global_hooks.win.height());
		global_hooks.win.on('scroll.fullscreen', $.throttle(100, function() {
			stickynav_handler.fn_move(global_hooks.win.scrollTop());
		}));
	}
	if (contactform_handler.valid) {
		if (site_height > contactform_handler.form.outerHeight()) {
			contactform_handler.fn_bind();
		}
	}
}
// less than desktop size
else {
	if (site_fullscreen) {
		global_hooks.body.removeClass('fullscreen');
	}
}

// resize
global_hooks.win.on('resize.fullscreen', $.debounce(100, function() {
	// update width and height
	site_width = global_hooks.win.width();
	site_height = global_hooks.win.height();
	stickynav_handler.state = -1;
	// less than desktop size
	if (site_width < 780) {
		if (site_fullscreen) {
			global_hooks.body.removeClass('fullscreen');
			stickynav_handler.headerbar.css({
				position: '',
				top: ''
			}).removeClass('hb-stickynav-start hb-stickynav-stop hb-stickynav-scroll');
			if (stickynav_handler.active) {
				stickynav_handler.active = false;
				global_hooks.win.off('scroll.fullscreen');
			}
		}
		if (contactform_handler.valid) {
			contactform_handler.fn_unbind();
		}
	}
	// greater than desktop size
	else {
		if (site_fullscreen) {
			global_hooks.body.addClass('fullscreen');
			stickynav_handler.fn_calc(global_hooks.win.scrollTop(), global_hooks.win.height());
			if (!stickynav_handler.active) {
				stickynav_handler.active = true;
				global_hooks.win.on('scroll.fullscreen', $.throttle(100, function() {
					stickynav_handler.fn_move(global_hooks.win.scrollTop());
				}));
			}
		}
		if (contactform_handler.valid) {
			if (site_height > contactform_handler.form.outerHeight()) {
				contactform_handler.fn_bind();
			}
		}
	}
}));